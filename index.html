<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMG - Gestão Escolar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #00d4ff; --text: #f1f5f9; --success: #22c55e; --warning: #eab308; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: auto; }
        .hidden { display: none !important; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        input { width: 100%; padding: 15px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; margin-bottom: 10px; box-sizing: border-box; }
        .btn { width: 100%; padding: 18px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase; margin-bottom: 10px; }
        .btn-success { background: var(--success); color: white; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-dark { background: #334155; color: white; }
        video, canvas { width: 100%; border-radius: 10px; background: #000; margin-bottom: 10px; }
        .foto-preview { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .filho-row { border-top: 1px solid #334155; padding-top: 10px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align:center; padding: 20px 0;">
        <h1 style="color:var(--primary); margin:0;">DÉCIO MACHADO GAIA</h1>
    </header>

    <div id="screen-home">
        <button class="btn btn-primary" onclick="goTo('screen-login-pai')"><i class="bi bi-people-fill"></i> ÁREA DOS PAIS</button>
        <button class="btn btn-dark" onclick="goTo('screen-login-school')"><i class="bi bi-mortarboard-fill"></i> MONITORIA</button>
        <button class="btn btn-dark" style="opacity:0.6" onclick="goTo('screen-login-diretoria')"><i class="bi bi-shield-lock-fill"></i> DIRETORIA</button>
    </div>

    <div id="screen-login-diretoria" class="card hidden">
        <h3>ACESSO DIRETORIA</h3>
        <input type="password" id="pass-diretoria" placeholder="SENHA DE ACESSO">
        <button class="btn btn-success" onclick="loginDiretoria()">ENTRAR</button>
        <button class="btn btn-dark" onclick="goTo('screen-home')">VOLTAR</button>
    </div>

    <div id="screen-panel-diretoria" class="card hidden">
        <h3 style="color:var(--primary)">CADASTRO DE RESPONSÁVEL</h3>
        <input type="number" id="reg-cpf" placeholder="CPF DO PAI (LOGIN)">
        <input type="text" id="reg-nome-pai" placeholder="NOME DO RESPONSÁVEL">
        
        <div id="container-filhos">
            <div class="filho-row">
                <input type="text" class="reg-aluno" placeholder="NOME DO ALUNO">
                <input type="text" class="reg-serie" placeholder="SÉRIE (Ex: 4ºA)">
            </div>
        </div>
        <button class="btn btn-dark" style="padding:10px; font-size:12px;" onclick="addFilhoCampo()">+ ADICIONAR FILHO</button>

        <h4 style="margin-top:20px;">FOTO DO RESPONSÁVEL</h4>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" class="hidden"></canvas>
        <img id="photo-preview" class="hidden" style="width:100%; border-radius:10px; margin-bottom:10px;">
        <button id="btn-snap" class="btn btn-primary" onclick="takePhoto()">TIRAR FOTO</button>

        <button class="btn btn-success" onclick="salvarCadastro()">FINALIZAR CADASTRO</button>
        <button class="btn btn-dark" onclick="location.reload()">SAIR</button>
    </div>

    <div id="screen-login-pai" class="card hidden">
        <h3>IDENTIFICAÇÃO</h3>
        <input type="number" id="cpf-login" placeholder="DIGITE SEU CPF">
        <button class="btn btn-success" onclick="authPai()">VERIFICAR</button>
        <button class="btn btn-dark" onclick="goTo('screen-home')">VOLTAR</button>
    </div>

    <div id="screen-chamada" class="card hidden" style="text-align:center;">
        <img id="display-foto-pai" style="width:120px; height:120px; border-radius:60px; object-fit:cover; border:3px solid var(--primary);">
        <h3 id="display-nome-pai"></h3>
        <div id="display-filhos" style="margin-bottom:20px; font-style:italic;"></div>
        <button class="btn btn-success" onclick="enviarChamada()">ESTOU NO PORTÃO</button>
    </div>

    <div id="screen-monitor" class="card hidden">
        <h2 style="color:var(--warning)">FILA DE SAÍDA</h2>
        <div id="fila-lista"></div>
        <button class="btn btn-dark" onclick="location.reload()">VOLTAR</button>
    </div>

</div>

<script>
    // CONFIGURAÇÃO FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyBDdVksMaItsqib7g2wIye78q70q0KK3fk",
        authDomain: "saidagaia.firebaseapp.com",
        databaseURL: "https://saidagaia-default-rtdb.firebaseio.com",
        projectId: "saidagaia",
        storageBucket: "saidagaia.firebasestorage.app",
        messagingSenderId: "711059544383",
        appId: "1:711059544383:web:217491ab4525a083709b8a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let streamVideo;
    let fotoData = null;
    let dadosPaiLogado = null;

    function goTo(id) {
        document.querySelectorAll('.container > div:not(header)').forEach(el => el.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id === 'screen-panel-diretoria') startCamera();
    }

    // --- DIRETORIA ---
    function loginDiretoria() {
        if(document.getElementById('pass-diretoria').value === '1234') {
            goTo('screen-panel-diretoria');
        } else { alert("Senha Incorreta!"); }
    }

    async function startCamera() {
        streamVideo = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById('video').srcObject = streamVideo;
    }

    function takePhoto() {
        const canvas = document.getElementById('canvas');
        const video = document.getElementById('video');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        fotoData = canvas.toDataURL('image/jpeg');
        document.getElementById('photo-preview').src = fotoData;
        document.getElementById('photo-preview').classList.remove('hidden');
        video.classList.add('hidden');
        document.getElementById('btn-snap').innerText = "TIRAR OUTRA";
    }

    function addFilhoCampo() {
        const div = document.createElement('div');
        div.className = 'filho-row';
        div.innerHTML = `<input type="text" class="reg-aluno" placeholder="NOME DO ALUNO"><input type="text" class="reg-serie" placeholder="SÉRIE">`;
        document.getElementById('container-filhos').appendChild(div);
    }

    function salvarCadastro() {
        const cpf = document.getElementById('reg-cpf').value;
        const nomePai = document.getElementById('reg-nome-pai').value.toUpperCase();
        const nomesAlunos = document.querySelectorAll('.reg-aluno');
        const seriesAlunos = document.querySelectorAll('.reg-serie');

        let filhos = [];
        nomesAlunos.forEach((n, i) => {
            if(n.value) filhos.push({ nome: n.value.toUpperCase(), serie: seriesAlunos[i].value.toUpperCase() });
        });

        if(!cpf || !fotoData) return alert("CPF e Foto são obrigatórios!");

        db.ref('cadastros/' + cpf).set({
            cpf_pai: cpf,
            responsavel: nomePai,
            filhos: filhos,
            foto: fotoData
        }).then(() => {
            alert("Cadastro realizado com sucesso!");
            location.reload();
        });
    }

    // --- PAIS ---
    function authPai() {
        const cpf = document.getElementById('cpf-login').value;
        db.ref('cadastros/' + cpf).once('value', snap => {
            if(snap.exists()) {
                dadosPaiLogado = snap.val();
                document.getElementById('display-foto-pai').src = dadosPaiLogado.foto;
                document.getElementById('display-nome-pai').innerText = dadosPaiLogado.responsavel;
                document.getElementById('display-filhos').innerText = "Filhos: " + dadosPaiLogado.filhos.map(f => f.nome).join(', ');
                goTo('screen-chamada');
            } else { alert("CPF não localizado!"); }
        });
    }

    function enviarChamada() {
        dadosPaiLogado.filhos.forEach(f => {
            db.ref('fila/').push({
                aluno: f.nome,
                serie: f.serie,
                responsavel: dadosPaiLogado.responsavel,
                foto: dadosPaiLogado.foto,
                hora: new Date().toLocaleTimeString(),
                status: 'aguardando'
            });
        });
        alert("Aviso enviado! Aguarde no portão.");
        location.reload();
    }

    // --- MONITORIA ---
    function loginMonitor() { /* Implementar senha se quiser */ goTo('screen-monitor'); listenFila(); }

    function listenFila() {
        db.ref('fila/').on('value', snap => {
            const container = document.getElementById('fila-lista');
            container.innerHTML = "";
            const dados = snap.val();
            if(dados) {
                Object.keys(dados).forEach(id => {
                    const item = dados[id];
                    if(item.status === 'aguardando') {
                        container.innerHTML += `
                        <div class="card" style="display:flex; align-items:center; gap:15px; border-left:5px solid var(--warning)">
                            <img src="${item.foto}" style="width:70px; height:70px; border-radius:10px; object-fit:cover;">
                            <div style="flex:1">
                                <b style="color:var(--primary)">${item.aluno}</b> (${item.serie})<br>
                                <small>Pai: ${item.responsavel}</small>
                            </div>
                            <button class="btn btn-success" style="width:auto; padding:10px;" onclick="darBaixa('${id}')">OK</button>
                        </div>`;
                    }
                });
            }
        });
    }

    function darBaixa(id) { db.ref('fila/' + id).update({ status: 'entregue' }); }

</script>
</body>
</html>
