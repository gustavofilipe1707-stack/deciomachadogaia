<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMG - Saída Escolar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #00d4ff; --text: #f1f5f9; --success: #22c55e; --warning: #eab308; --danger: #ef4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; min-height: 100vh; }
        .container { max-width: 800px; margin: auto; width: 100%; }
        .hidden { display: none !important; }
        header { text-align: center; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 20px; }
        header h1 { font-size: 20px; color: var(--primary); margin: 5px 0; text-transform: uppercase; font-weight: 800; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); }
        input { width: 100%; padding: 18px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; margin-bottom: 12px; font-size: 18px; text-align: center; box-sizing: border-box; }
        .btn-cheguei { width: 100%; padding: 18px; background: var(--success); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 800; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .btn-cheguei:active { transform: scale(0.98); }
        .btn-access { width: 100%; padding: 20px; border-radius: 12px; border: 1px solid #334155; background: var(--card); color: white; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 12px; }
        .btn-voltar { background: #334155; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; cursor: pointer; margin-top: 10px; font-weight: bold; text-transform: uppercase; }
        .fila-item { background: #0a0f1d; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .resumo-filhos { background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--primary); text-align: left; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; text-transform: uppercase; margin-top: 10px; }
        th { text-align: left; color: var(--primary); padding: 8px; border-bottom: 2px solid #334155; }
        td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>DÉCIO MACHADO GAIA</h1>
        <p style="font-size:12px; opacity:0.7">Sistema de Saída Monitorada</p>
    </header>

    <div id="screen-home">
        <button class="btn-access" onclick="goTo('screen-login-pai')"><i class="bi bi-people-fill"></i> ÁREA DOS PAIS</button>
        <button class="btn-access" onclick="goTo('screen-login-school')"><i class="bi bi-mortarboard-fill"></i> MONITORIA ESCOLA</button>
    </div>

    <div id="screen-login-pai" class="card hidden">
        <h3 style="text-align:center">IDENTIFICAÇÃO</h3>
        <input type="number" id="cpf-input" placeholder="DIGITE SEU CPF">
        <button class="btn-cheguei" onclick="validarCPF()">BUSCAR ALUNOS</button>
        <button class="btn-voltar" onclick="goTo('screen-home')">VOLTAR</button>
    </div>

    <div id="screen-confirmar" class="card hidden">
        <h3 style="text-align:center">ALUNOS ENCONTRADOS:</h3>
        <div id="lista-filhos-vinculados" class="resumo-filhos"></div>
        <button class="btn-cheguei" onclick="enviarChamadaMultipla()">ESTOU NO PORTÃO</button>
        <button class="btn-voltar" onclick="location.reload()">CANCELAR</button>
    </div>

    <div id="screen-status" class="card hidden" style="text-align:center;">
        <div id="status-waiting">
            <h3 style="color:var(--warning)">AGUARDANDO LIBERAÇÃO...</h3>
            <div id="cronometro-pai" style="font-size: 50px; font-weight: 800; margin: 20px 0;">00:00</div>
        </div>
        <div id="status-finished" class="hidden">
            <i class="bi bi-check-circle-fill" style="font-size: 60px; color: var(--success);"></i>
            <h2 style="color:var(--success)">LIBERADO!</h2>
            <p>Obrigado por esperar e boa viagem.</p>
        </div>
        <button class="btn-voltar" onclick="location.reload()">INÍCIO</button>
    </div>

    <div id="screen-monitor" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>FILA ATUAL</h2>
            <span id="badge-total" style="background:var(--primary); color:#000; padding:2px 12px; border-radius:15px; font-weight:bold;">0</span>
        </div>
        <div id="fila-monitor" style="margin-top:15px;"></div>
        <h3 style="margin-top:25px; border-top: 1px solid #444; padding-top:10px; font-size:14px;">HISTÓRICO DE SAÍDAS</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>ALUNO</th><th>SALA</th><th>HORA</th><th>ESPERA</th></tr></thead>
                <tbody id="lista-entregues"></tbody>
            </table>
        </div>
        <button class="btn-voltar" onclick="location.reload()">SAIR</button>
    </div>

    <div id="screen-login-school" class="card hidden">
        <input type="password" id="pass-school" placeholder="SENHA DA ESCOLA">
        <button class="btn-cheguei" onclick="loginMonitor()">ACESSAR</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBDdVksMaItsqib7g2wIye78q70q0KK3fk",
        authDomain: "saidagaia.firebaseapp.com",
        databaseURL: "https://saidagaia-default-rtdb.firebaseio.com",
        projectId: "saidagaia",
        storageBucket: "saidagaia.firebasestorage.app",
        messagingSenderId: "711059544383",
        appId: "1:711059544383:web:217491ab4525a083709b8a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let alunosParaEnviar = [];
    let idsMonitorados = [];

    function goTo(id) {
        document.querySelectorAll('.container > div:not(header)').forEach(el => el.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function validarCPF() {
        const cpf = document.getElementById('cpf-input').value.trim();
        if(!cpf) return alert("Por favor, digite o CPF.");

        db.ref('cadastros').orderByChild('cpf_pai').equalTo(cpf).once('value', snapshot => {
            const data = snapshot.val();
            if(data) {
                alunosParaEnviar = Object.values(data);
                const container = document.getElementById('lista-filhos-vinculados');
                container.innerHTML = alunosParaEnviar.map(a => `<div style="margin-bottom:5px;">• <strong>${a.aluno}</strong> (${a.sala})</div>`).join('');
                goTo('screen-confirmar');
            } else {
                alert("CPF não encontrado no sistema.");
            }
        });
    }

    function enviarChamadaMultipla() {
        idsMonitorados = [];
        alunosParaEnviar.forEach(a => {
            const newRef = db.ref('fila/').push();
            idsMonitorados.push(newRef.key);
            newRef.set({
                aluno: a.aluno, sala: a.sala, responsavel: a.responsavel,
                chegada: new Date().getTime(), status: 'aguardando'
            });
        });
        iniciarCronometro();
        escutarStatusPai();
        goTo('screen-status');
    }

    function escutarStatusPai() {
        idsMonitorados.forEach(id => {
            db.ref('fila/' + id).on('value', snap => {
                if(snap.val() && snap.val().status === 'entregue') {
                    document.getElementById('status-waiting').classList.add('hidden');
                    document.getElementById('status-finished').classList.remove('hidden');
                }
            });
        });
    }

    function iniciarCronometro() {
        const inicio = new Date();
        const t = setInterval(() => {
            if(!document.getElementById('status-finished').classList.contains('hidden')) clearInterval(t);
            const diff = Math.floor((new Date() - inicio)/1000);
            const m = Math.floor(diff/60).toString().padStart(2,'0');
            const s = (diff%60).toString().padStart(2,'0');
            document.getElementById('cronometro-pai').innerText = `${m}:${s}`;
        }, 1000);
    }

    function loginMonitor() {
        if(document.getElementById('pass-school').value === 'escola') {
            goTo('screen-monitor');
            escutarBancoMonitor();
        } else { alert("Senha incorreta."); }
    }

    function escutarBancoMonitor() {
        db.ref('fila/').on('value', snapshot => {
            const fila = document.getElementById('fila-monitor');
            const historico = document.getElementById('lista-entregues');
            fila.innerHTML = ""; historico.innerHTML = "";
            let count = 0;
            const dados = snapshot.val();
            if(dados) {
                const itens = Object.keys(dados).map(k => ({id: k, ...dados[k]})).reverse();
                itens.forEach(item => {
                    if(item.status === 'aguardando') {
                        count++;
                        const min = Math.floor((new Date().getTime() - item.chegada) / 60000);
                        fila.innerHTML += `
                            <div class="fila-item">
                                <div><strong>${item.aluno}</strong> <span style="color:var(--warning); font-size:12px;">${min}m</span><br><small>${item.sala} | ${item.responsavel}</small></div>
                                <button class="btn-cheguei" style="width:auto; padding:10px 15px;" onclick="darBaixa('${item.id}', ${item.chegada})">LIBERAR</button>
                            </div>`;
                    } else {
                        historico.innerHTML += `<tr><td>${item.aluno}</td><td>${item.sala}</td><td>${item.horaSaida}</td><td style="color:var(--warning)">${item.tempoTotal}</td></tr>`;
                    }
                });
            }
            document.getElementById('badge-total').innerText = count;
        });
    }

    function darBaixa(id, chegada) {
        const totalMin = Math.floor((new Date().getTime() - chegada) / 60000);
        db.ref('fila/' + id).update({
            status: 'entregue',
            horaSaida: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            tempoTotal: totalMin + " MIN"
        });
    }
</script>
</body>
</html>
